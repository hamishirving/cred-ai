# Database (Drizzle ORM + Hybrid Migrations)

## Architecture

| Layer | Tool | Purpose |
|-------|------|---------|
| **Schema definitions** | Drizzle `pgTable()` | Types, ERD, query builder |
| **Migration generation** | Drizzle Kit | Generate SQL from schema |
| **Migration application** | Supabase CLI | Apply SQL to database |
| **Queries** | Drizzle ORM | Type-safe database access |

**Why hybrid:** Drizzle Kit has bugs with Supabase's auth schema when introspecting ([#4632](https://github.com/drizzle-team/drizzle-orm/issues/4632)). We use Drizzle to generate migrations but Supabase CLI to apply them.

**Single source of truth:** Drizzle schema files define the database structure. All changes flow from schema to database.

## Schema Changes

### Step 1: Update Drizzle Schema
Edit files in `lib/db/schema/` - this updates:
- TypeScript types (used throughout app)
- ERD visualization (reads from schema)
- Query builder definitions

### Step 2: Generate Migration
```bash
pnpm db:generate  # Creates SQL migration from schema diff
```

### Step 3: Apply Migration
```bash
pnpm db:push      # Applies pending migrations to remote DB
```

### Step 4: Verify
```bash
pnpm db:studio    # Browse data to confirm changes
pnpm db:seed      # Re-seed if needed
```

## Commands

```bash
pnpm db:generate  # Generate SQL migration from schema changes (Drizzle Kit)
pnpm db:push      # Apply pending migrations to remote DB (Supabase CLI)
pnpm db:studio    # Open Drizzle Studio (browse data)
pnpm db:seed      # Seed demo data (UK + US orgs)
pnpm db:clear     # Clear all seeded data
```

## File Structure

```
lib/db/
├── schema/           # Drizzle table definitions (source of truth)
├── queries.ts        # All database queries
├── index.ts          # DB connection export
└── seed/             # Seed data scripts

supabase/
├── migrations/       # SQL migrations (generated by Drizzle Kit)
│   └── meta/         # Drizzle migration tracking
└── config.toml       # Supabase project config
```

## Seed Data

Multi-market demo data for UK and US healthcare compliance.

```bash
pnpm db:seed    # Wipe and reseed all data (~60s)
pnpm db:clear   # Clear only (no reseed)
```

**Organisations seeded:**
- **Meridian Healthcare** (UK agency) - NHS Trusts, care homes
- **Oakwood Care** (UK direct employer) - England + Scotland branches
- **TravelNurse Pro** (US agency) - Multi-state travel nursing
- **Lakeside Health System** (US direct employer) - Texas hospital system

**Per organisation:**
- 8-10 candidates with varied compliance states
- Realistic compliance packages (UK: DBS/NMC/RTW, US: state licenses/BLS/ACLS)
- Activity history, escalations, pipeline positions

**Seed structure:**
```
seed/
├── index.ts          # Main orchestrator
├── db.ts             # Database connection
├── clear.ts          # Wipe all tables
├── utils.ts          # Date/random helpers
├── markets/          # Compliance element definitions
│   ├── uk.ts         # 18 UK elements, 6 packages
│   └── us.ts         # 22 US elements, 7 packages
└── candidates/       # Named candidate profiles
    ├── uk-candidates.ts
    └── us-candidates.ts
```

See `docs/PRD-SEED-DATA.md` for full specification.

## Query Patterns

All queries go in `queries.ts`. Follow existing patterns:

```ts
export async function getThingById({ id }: { id: string }) {
  const [result] = await db
    .select()
    .from(thing)
    .where(eq(thing.id, id));
  return result;
}

export async function saveThings({ items }: { items: NewThing[] }) {
  return db.insert(thing).values(items);
}
```

## Conventions

- Use uuid for all IDs: `uuid('id').primaryKey().notNull().defaultRandom()`
- Always add `createdAt`: `timestamp('createdAt').notNull().defaultNow()`
- Use `jsonb` for flexible data, typed with `.$type<MyType>()`
- Queries return single item or array, never undefined - check length
